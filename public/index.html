<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
     <script id="zsiqscript" src="https://salesiq.zohopublic.in/widget?wc=siq432810251110ab8fa1526b5b918a80f6ca4a6de27ee9e3572852a9858c9dc685" defer></script>

   <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
     <script id="zsiqscript" src="https://salesiq.zohopublic.in/widget?wc=siq432810251110ab8fa1526b5b918a80f6ca4a6de27ee9e3572852a9858c9dc685" defer></script>

    
</script>
</head> 
<body>

    <input type="email" id="email" required placeholder="Email">
    <input type="password" id="password" required placeholder="Password">
    <button type="submit" id ="but">Login</button>
    <div id="res"></div>
    <div id="response"></div> 


 

 <script>
        var $zoho = $zoho || {};
        $zoho.salesiq = $zoho.salesiq || {
            // Set up the ready callback
            ready: function() {
                // Now, $zoho is guaranteed to be defined and salesiq methods are ready.
                
                // Function to Get the Visitor ID from SalesIQ (now safe to call)
                function getZohoVisitorId() {
                    try {
                        // Using the standard visitor info ID as it's the most reliable 
                        const visitorInfo = $zoho.salesiq.visitor.info.getVisitor();
                        return visitorInfo.id; 
                    } catch (e) {
                        console.error("Error retrieving SalesIQ Visitor ID inside ready:", e);
                        return null;
                    }
                }

                // Event Listener for the Login Button
                document.getElementById('but').addEventListener('click', async () => {
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    const visitorId = getZohoVisitorId(); // NO await needed here

                    console.log("Visitor ID retrieved:", visitorId);
                    document.getElementById('res').textContent = "Visitor ID: " + visitorId;

                    if (!visitorId) {
                        alert("Could not retrieve Zoho SalesIQ Visitor ID. Check console.");
                        return;
                    }

                    // Proceed with fetch call to your Express server /login endpoint
                    try {
                        const response = await fetch('https://parky-zobot-cliqtrix.onrender.com/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                email: email,
                                password: password,
                                zoho_visitor_id: visitorId 
                            })
                        });

                        const data = await response.json();
                        if (data.botToken) {
                            document.getElementById('res').textContent = "Login Successful! Token received.";
                            // For testing, you may console.log it, but DO NOT save long-lived token to localStorage in production.
                            console.log("Bot Token:", data.botToken); 
                        } else {
                            alert('Login failed: ' + data.message);
                        }
                    } catch (error) {
                        console.error("Fetch error:", error);
                        alert("Network or Server error during login.");
                    }
                });
            }
        };
    </script>
//<script>
    // **1. Function to Get the Visitor ID from SalesIQ**
    // function getZohoVisitorId() {
    // return new Promise((resolve) => {
    //     // Wait for Zoho SalesIQ to be ready
    //     $zoho.salesiq.ready(function() {
    //         try {
    //             let visitor = $zoho.salesiq.visitor.get();
    //             console.log("Visitor Info:", visitor);
    //             resolve(visitor.id);
    //         } catch (error) {
    //             console.error("Error retrieving visitor ID:", error);
    //             resolve(null);
    //         }
    //     });
    // });
// }
    //  $zoho.salesiq.ready = function() {
    //         $zoho.salesiq.visitor.id("67465746");
    
    //     }

    

//     // **2. Function to Handle Login and Send Data**
//     document.getElementById('but').addEventListener('click',async()=> {
//         const email = document.getElementById('email').value;
//         const password = document.getElementById('password').value;
//         const visitorId = await getZohoVisitorId();
//         console.log(visitorId);
//         document.getElementById('res').textContent = visitorId;

//         if (!visitorId) {
//             alert("Could not retrieve Zoho SalesIQ Visitor ID. Ensure the widget is loaded.");
//             return;
//         }

//         const response = await fetch('https://parky-zobot-cliqtrix.onrender.com/login', {
//             method: 'POST',
//             headers: {
//                 'Content-Type': 'application/json',
//             },
//             body: JSON.stringify({
//                 email: email,
//                 password: password,
//                 // **THIS IS THE CRITICAL LINE:**
//                 zoho_visitor_id: visitorId 
//             })
//         });

//         const data = await response.json();
//         if (data.botToken) {
//             localStorage.setItem('botToken', data.botToken);
//             alert('Login successful! Bot key saved to DB.');
//             // Note: We don't store the botKey in local storage.
//         } else {
//             alert('Login failed: ' + data.message);
//         }
//     })
// </script>

    
</body>
</html>